<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Jewelry Auction</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'css/Login-Register.css' %}" />
  </head>
  <body>
    <div class="header">
      <img
        alt="Jewelry Auction Logo"
        height="50"
        src="/img/logo.jpg"
        width="50"
      />
      <h1>Jewelry Auction</h1>
    </div>
    <div class="nav">
      <div class="form-option" id="login-option" onclick="showForm('login')">
        <h2>Login</h2>
      </div>
      <div
        class="form-option"
        id="register-option"
        onclick="showForm('register')"
      >
        <h2>Register</h2>
      </div>
    </div>
    <div class="form-wrapper">
        <div class="form-container" id="login-form">
          <div class="form-group">
            <i class="fas fa-user"></i>
            <input placeholder="Tên đăng nhập" type="text" id="login-username"/>
          </div>
          <div class="form-group">
            <i class="fas fa-key"></i>
            <input placeholder="Nhập mật khẩu" type="password" id="login-password"/>
          </div>
          <button class="submit-btn" onclick="login()">Đăng Nhập</button>
        </div>
        <div class="form-container" id="register-form" style="display: none">
          <div class="form-group">
            <i class="fas fa-user"></i>
            <input placeholder="Tên đăng nhập" type="text" id="register-username"/>
          </div>
          <div class="form-group">
            <i class="fas fa-user"></i>
            <input placeholder="Tên" type="text" id="register-first-name"/>
          </div>
          <div class="form-group">
            <i class="fas fa-user"></i>
            <input placeholder="Họ" type="text" id="register-last-name"/>
          </div>
          <div class="form-group">
            <i class="fas fa-key"></i>
            <input placeholder="Nhập mật khẩu" type="password" id="register-password"/>
          </div>
          <div class="form-group">
            <i class="fas fa-key"></i>
            <input placeholder="Xác nhận mật khẩu" type="password" id="register-password-confirm"/>
          </div>
          <button class="submit-btn" onclick="register()">Tạo tài khoản</button>
        </div>
      </div>

    <script>
      function showForm(form) {
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        const loginOption = document.getElementById("login-option");
        const registerOption = document.getElementById("register-option");

        if (form === "login") {
          loginForm.style.display = "block";
          registerForm.style.display = "none";
          loginOption.classList.add("active");
          registerOption.classList.remove("active");
        } else {
          loginForm.style.display = "none";
          registerForm.style.display = "block";
          registerOption.classList.add("active");
          loginOption.classList.remove("active");
        }
      }
      function login() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
      
        fetch('/api/users/login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // 'X-CSRFToken': getCookie('csrftoken') // Lấy CSRF token nếu cần
          },
          body: JSON.stringify({ username, password })
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Đăng nhập không thành công');
          }
        })
        .then(data => {
          console.log('Success:', data);
          alert('Đăng nhập thành công!');
          localStorage.setItem('token', data.token); // Lưu token vào localStorage
          window.location.href = '/'; // Chuyển hướng về trang chủ
        })
        .catch((error) => {
          console.error('Error:', error);
          alert(error);
        });
      }
      
      function register() {
          const username = document.getElementById('register-username').value;
          const firstName = document.getElementById('register-first-name').value;
          const lastName = document.getElementById('register-last-name').value;
          const password = document.getElementById('register-password').value;
          const passwordConfirm = document.getElementById('register-password-confirm').value;

          if (password !== passwordConfirm) {
              alert("Mật khẩu xác nhận không khớp.");
              return;
          }

          fetch('/api/users/register/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  // 'X-CSRFToken': getCookie('csrftoken') // Lấy CSRF token nếu cần
              },
              body: JSON.stringify({
                  username: username,
                  first_name: firstName,
                  last_name: lastName,
                  password: password,
                  password_confirm: passwordConfirm
              })
          })
          .then(response => {
              if (response.ok) {
                  return response.json();
              } else {
                  return response.json().then(data => {
                      let errorMsg = 'Đăng ký không thành công!';
                      if (data && data.username) {
                          errorMsg = data.username[0];
                      }
                      throw new Error(errorMsg);
                  });
              }
          })
          .then(data => {
              console.log('Success:', data);
              alert('Đăng ký thành công!');
              showForm('login'); // Hiển thị form đăng nhập
          })
          .catch((error) => {
              console.error('Error:', error);
              alert(error);
          });
      }

      // Hàm lấy giá trị của cookie (nếu cần dùng CSRF token)
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
    </script>
  </body>
</html>